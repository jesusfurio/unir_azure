---
- name: Install NFS Service
  hosts: nfs
  become: true
  vars:
    master: "10.22.21.147"
    worker: "10.22.21.151"
  tasks:
    - name: Actualización de SO
      dnf:
        name: "*"
        state: latest
    - name: Configuración de sincronización horaria
      command: timedatectl set-timezone Europe/Madrid
    - name: Instalación de Chrony
      dnf:
        name: chrony
        state: latest
    - name: Desactivación de SELinux
      command: sed -i s/=enforcing/=disabled/g /etc/selinux/config
    - name: Crear directorio NFS
      file:
        path: /srv/nfs
        state: directory
    - name: Instalación de paquetes
      dnf:
        name: '{{ item }}'
        state: latest
      loop:
        - nfs-utils
        - nfs4-acl-tools
        - wget
        - net-tools
    - name: Habilitar servicio NFS
      systemd:
        name: nfs-server
        enabled: yes
        masked: no
    - name: Iniciar servicio NFS
      systemd:
        name: nfs-server
        state: started
        enabled: True
    - name: Añadiendo hosts Kubernetes
      lineinfile:
        path: /etc/exports
        line: '{{ item }}'
      loop:
        - "/srv/nfs	{{ master }}(rw,sync)"
        - "/srv/nfs	{{ worker }}(rw,sync)"
    - name: Releemos fichero exports
      command: '{{ item }}'
      loop:
        - exportfs -r
        - exportfs -s
    - name: Habilitar servicio firewalld
      systemd:
        name: firewalld
        state: started
        enabled: True
    - name: Abriendo puertos en Firewalld
      firewalld:
        service: '{{ item }}'
        state: enabled
      loop:
        - nfs
        - mountd
